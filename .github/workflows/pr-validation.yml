name: Pull Request Validation

# Trigger: Solo en Pull Requests
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main ]

jobs:
  # Job de validaci√≥n de PR
  pr-validation:
    name: PR Quality Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Verificar t√≠tulo del PR
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        echo "PR Title: $PR_TITLE"
        
        # Verificar que sigue Conventional Commits
        if echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+'; then
          echo "‚úÖ T√≠tulo del PR sigue Conventional Commits"
        else
          echo "‚ö†Ô∏è  T√≠tulo del PR no sigue Conventional Commits"
          echo "   Formato esperado: tipo(scope): descripci√≥n"
          echo "   Ejemplo: feat(api): agregar endpoint de usuarios"
        fi
        
    - name: Verificar descripci√≥n del PR
      run: |
        BODY_LENGTH=$(echo "${{ github.event.pull_request.body }}" | wc -c)
        
        if [ $BODY_LENGTH -gt 50 ]; then
          echo "‚úÖ PR tiene descripci√≥n adecuada ($BODY_LENGTH caracteres)"
        else
          echo "‚ö†Ô∏è  PR tiene descripci√≥n muy corta ($BODY_LENGTH caracteres)"
          echo "   Considera agregar m√°s contexto sobre los cambios"
        fi
        
    - name: Verificar tama√±o del PR
      run: |
        ADDITIONS=${{ github.event.pull_request.additions }}
        DELETIONS=${{ github.event.pull_request.deletions }}
        CHANGED_FILES=${{ github.event.pull_request.changed_files }}
        
        echo "üìä Estad√≠sticas del PR:"
        echo "  - L√≠neas agregadas: $ADDITIONS"
        echo "  - L√≠neas eliminadas: $DELETIONS"
        echo "  - Archivos modificados: $CHANGED_FILES"
        
        TOTAL_CHANGES=$((ADDITIONS + DELETIONS))
        
        if [ $TOTAL_CHANGES -lt 500 ]; then
          echo "‚úÖ PR de tama√±o apropiado ($TOTAL_CHANGES l√≠neas)"
        elif [ $TOTAL_CHANGES -lt 1000 ]; then
          echo "‚ö†Ô∏è  PR grande ($TOTAL_CHANGES l√≠neas) - considera dividirlo"
        else
          echo "‚ùå PR muy grande ($TOTAL_CHANGES l√≠neas) - dif√≠cil de revisar"
        fi
        
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Ejecutar tests del PR
      run: |
        python src/test_app.py
        echo "‚úÖ Tests del PR pasaron correctamente"
        
    - name: Verificar archivos modificados
      run: |
        echo "üìÇ Archivos modificados en este PR:"
        git diff --name-only origin/main...HEAD
        
    - name: Detectar cambios cr√≠ticos
      run: |
        # Verificar si hay cambios en archivos cr√≠ticos
        if git diff --name-only origin/main...HEAD | grep -qE '(\.github/|requirements\.txt|setup\.py)'; then
          echo "‚ö†Ô∏è  Este PR modifica archivos cr√≠ticos de configuraci√≥n"
          echo "   Requiere revisi√≥n cuidadosa"
        fi
        
  # Job de an√°lisis de c√≥digo del PR
  pr-code-quality:
    name: PR Code Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR
      uses: actions/checkout@v4
      
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Instalar herramientas de an√°lisis
      run: |
        pip install flake8 radon
        
    - name: An√°lisis de complejidad
      run: |
        echo "üìä An√°lisis de complejidad ciclom√°tica:"
        radon cc src/ -a -nb || true
        
    - name: An√°lisis de mantenibilidad
      run: |
        echo "üìä √çndice de mantenibilidad:"
        radon mi src/ -nb || true
        
  # Job de comentarios autom√°ticos
  pr-comment:
    name: PR Auto Comment
    runs-on: ubuntu-latest
    needs: [pr-validation, pr-code-quality]
    if: always()
    permissions:
      pull-requests: write
    
    steps:
    - name: Comentar en el PR
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ü§ñ CI Pipeline Report')
          );
          
          const commentBody = `
          ## ü§ñ CI Pipeline Report
          
          **Status:** ${{ needs.pr-validation.result == 'success' && needs.pr-code-quality.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}
          
          ### Validation Results
          
          - **PR Validation:** ${{ needs.pr-validation.result == 'success' && '‚úÖ' || '‚ùå' }}
          - **Code Quality:** ${{ needs.pr-code-quality.result == 'success' && '‚úÖ' || '‚ùå' }}
          
          ### Next Steps
          
          ${{ needs.pr-validation.result == 'success' && needs.pr-code-quality.result == 'success' && '‚úÖ Este PR est√° listo para revisi√≥n humana' || '‚ö†Ô∏è Por favor revisa los errores reportados arriba' }}
          
          ---
          
          *Este comentario es generado autom√°ticamente por GitHub Actions*
          `;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          }
