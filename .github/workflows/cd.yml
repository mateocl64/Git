# Pipeline de Continuous Deployment (CD)
# Actividad 6.2 - Despliegue a entorno de pruebas con Docker

name: CD Pipeline - Deploy to Testing

on:
  push:
    branches: [main]
  workflow_dispatch: # Permitir ejecuciÃ³n manual

env:
  IMAGE_NAME: devops-app
  IMAGE_TAG: latest
  CONTAINER_NAME: devops-app-container

jobs:
  # Job 1: Build de la imagen Docker
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .
          docker build -t ${{ env.IMAGE_NAME }}:${{ github.sha }} .
      
      - name: Inspect Docker image
        run: |
          docker images | grep ${{ env.IMAGE_NAME }}
          docker inspect ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
      
      - name: Save Docker image as artifact
        run: |
          docker save ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} -o devops-app.tar
      
      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: devops-app.tar
          retention-days: 1

  # Job 2: Test de la imagen Docker
  test:
    name: Test Docker Container
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      
      - name: Load Docker image
        run: docker load -i devops-app.tar
      
      - name: Run container for testing
        run: |
          docker run -d \
            --name test-container \
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
      
      - name: Wait for container to start
        run: sleep 5
      
      - name: Check container is running
        run: |
          docker ps -a
          docker inspect test-container
      
      - name: Check container health
        run: |
          docker exec test-container python -c "import src.app; print('âœ… App importada correctamente')"
      
      - name: Run tests inside container
        run: |
          docker exec test-container python -m pytest src/test_app.py -v --color=yes || true
      
      - name: Get container logs
        if: always()
        run: |
          echo "=== Container Logs ==="
          docker logs test-container
      
      - name: Stop and remove test container
        if: always()
        run: |
          docker stop test-container || true
          docker rm test-container || true

  # Job 3: Security scan de la imagen
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      
      - name: Load Docker image
        run: docker load -i devops-app.tar
      
      - name: Run Trivy security scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

  # Job 4: Deploy simulado a entorno de pruebas
  deploy:
    name: Deploy to Testing Environment
    runs-on: ubuntu-latest
    needs: [build, test, security]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      
      - name: Load Docker image
        run: docker load -i devops-app.tar
      
      - name: Stop existing container (if any)
        run: |
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true
      
      - name: Deploy with Docker Compose
        run: |
          docker-compose up -d
      
      - name: Wait for deployment
        run: sleep 10
      
      - name: Verify deployment
        run: |
          echo "=== Container Status ==="
          docker ps -a
          
          echo ""
          echo "=== Container Inspect ==="
          docker inspect ${{ env.CONTAINER_NAME }}
          
          echo ""
          echo "=== Container Health ==="
          docker exec ${{ env.CONTAINER_NAME }} python -c "import src.app; print('âœ… Deployment successful!')"
      
      - name: Get deployment logs
        run: |
          echo "=== Deployment Logs ==="
          docker logs ${{ env.CONTAINER_NAME }}
      
      - name: Test application functionality
        run: |
          echo "=== Testing App Functions ==="
          docker exec ${{ env.CONTAINER_NAME }} python -c "
          from src.app import saludar, calcular_progreso, obtener_estadisticas
          print(saludar('GitHub Actions'))
          print(f'Progreso: {calcular_progreso(8, 10)}%')
          print(f'Stats: {obtener_estadisticas()}')
          "
      
      - name: Cleanup (stop container after tests)
        if: always()
        run: |
          docker-compose down
          docker system prune -f

  # Job 5: Reporte final de CD
  report:
    name: CD Report
    runs-on: ubuntu-latest
    needs: [build, test, security, deploy]
    if: always()
    
    steps:
      - name: Generate deployment report
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          CD PIPELINE EXECUTION REPORT              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Image: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          echo "ğŸ”– Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ“… Date: $(date)"
          echo ""
          echo "âœ… Build: ${{ needs.build.result }}"
          echo "âœ… Test: ${{ needs.test.result }}"
          echo "âœ… Security: ${{ needs.security.result }}"
          echo "âœ… Deploy: ${{ needs.deploy.result }}"
          echo ""
          
          if [ "${{ needs.build.result }}" == "success" ] && \
             [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.security.result }}" == "success" ] && \
             [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "ğŸ‰ CD PIPELINE: SUCCESS"
            exit 0
          else
            echo "âŒ CD PIPELINE: FAILED"
            exit 1
          fi
